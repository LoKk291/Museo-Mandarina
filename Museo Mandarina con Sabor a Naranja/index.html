<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Museo Mandarina 3D</title>
    <link rel="stylesheet" href="style.css">
    <!-- Import Map para usar Three.js sin bundler -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <style>
        #error-console {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(200, 0, 0, 0.9);
            color: white;
            padding: 20px;
            z-index: 9999;
            display: none;
            font-family: monospace;
        }

        #stats-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 15px;
            font-family: 'Courier New', monospace;
            border: 2px solid #00ff00;
            border-radius: 5px;
            z-index: 2000;
            min-width: 200px;
            box-shadow: 0 0 10px #00ff00;
        }

        #stats-panel.hidden {
            display: none;
        }

        /* Audio Controls */
        #audio-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #FFD700;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 2000;
            color: #FFD700;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        #audio-controls.hidden {
            display: none;
        }

        #stop-music {
            background: #FF4444;
            color: white;
            border: none;
            padding: 8px 15px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            font-family: inherit;
            text-transform: uppercase;
        }

        #stop-music:hover {
            background: #FF0000;
        }

        #music-volume {
            width: 100px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <style>
        #vinyl-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9), rgba(50, 50, 50, 0.9));
            color: #FFD700;
            padding: 15px 25px;
            border-left: 5px solid #FFD700;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            font-family: 'Courier New', monospace;
            z-index: 3000;
            transform: translateX(120%);
            transition: transform 0.5s ease-out;
            max-width: 350px;
        }

        #vinyl-toast.show {
            transform: translateX(0);
        }

        #vinyl-toast h4 {
            margin: 0;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }

        #vinyl-toast p {
            margin: 5px 0 0 0;
            font-size: 16px;
            font-weight: bold;
        }
    </style>
    <div id="error-console"></div>
    <div id="vinyl-toast">
        <h4>Ahora estas escuchando: </h4>
        <p id="vinyl-song-title">Song Name</p>
    </div>

    <!-- Audio Controls -->
    <div id="audio-controls" class="hidden">
        <button id="stop-music">STOP</button>
        <div style="display: flex; flex-direction: column; align-items: center;">
            <label for="music-volume" style="font-size: 10px; margin-bottom: 2px;">VOL</label>
            <input type="range" id="music-volume" min="0" max="1" step="0.1" value="0.5">
        </div>
    </div>
    <script>
        let errorTimeout;
        function showTempError(content) {
            const div = document.getElementById('error-console');
            div.style.display = 'block';
            div.innerHTML += content;

            if (errorTimeout) clearTimeout(errorTimeout);
            errorTimeout = setTimeout(() => {
                div.style.display = 'none';
                div.innerHTML = ''; // Limpiar para la pr√≥xima
            }, 5000);
        }

        window.onerror = function (msg, url, line, col, error) {
            showTempError(`<h3>Error Detectado:</h3><p>${msg}</p><p>En: ${url}:${line}</p><br>Trying to run local modules (file://) without a server often causes this. Use the start_game.bat file!`);
        };
        window.addEventListener('unhandledrejection', function (event) {
            // Ignore PointerLock SecurityError (User pressed ESC or clicked too fast)
            if (event.reason && (event.reason.name === 'SecurityError' ||
                (typeof event.reason === 'string' && event.reason.includes('exited the lock')))) {
                return;
            }
            showTempError(`<h3>Error de Promesa:</h3><p>${event.reason}</p>`);
        });
    </script>
    <div id="game-container"></div>
    <!-- Piano Interface -->
    <div id="piano-modal" class="modal-overlay hidden">
        <div class="piano-container">
            <div class="piano-header">
                <h2>Piano de Cola</h2>
                <button id="close-piano" class="close-btn">X</button>
            </div>
            <div class="piano-keys" id="piano-keys">
                <!-- Keys generated via JS or hardcoded? Hardcoding for control -->
                <!-- Octave 3 -->
                <div class="key white" data-note="C3" data-key="a"></div>
                <div class="key black" data-note="C#3" data-key="w"></div>
                <div class="key white" data-note="D3" data-key="s"></div>
                <div class="key black" data-note="D#3" data-key="e"></div>
                <div class="key white" data-note="E3" data-key="d"></div>
                <div class="key white" data-note="F3" data-key="f"></div>
                <div class="key black" data-note="F#3" data-key="t"></div>
                <div class="key white" data-note="G3" data-key="g"></div>
                <div class="key black" data-note="G#3" data-key="y"></div>
                <div class="key white" data-note="A3" data-key="h"></div>
                <div class="key black" data-note="A#3" data-key="u"></div>
                <div class="key white" data-note="B3" data-key="j"></div>

                <!-- Octave 4 -->
                <div class="key white" data-note="C4" data-key="k"></div>
                <div class="key black" data-note="C#4" data-key="o"></div>
                <div class="key white" data-note="D4" data-key="l"></div>
                <div class="key black" data-note="D#4" data-key="p"></div>
                <div class="key white" data-note="E4" data-key="√±"></div>
            </div>
            <div class="piano-hint">
                <p>Usa el teclado: A S D F G H J K L √ë (Blancas) | W E T Y U O P (Negras)</p>
            </div>
        </div>
    </div>

    <!-- Instrucciones de inicio -->
    <div id="instructions">
        <div class="menu-box">
            <h1>Museo Mandarina<br><span style="font-size: 0.6em">con Sabor a Naranja</span></h1>
            <p>> Haz click para comenzar_</p>
            <div class="controls-info">
                <p>[W,A,S,D] :: MOVERSE</p>
                <p>[MOUSE] :: MIRAR</p>
                <p>[CLICK] :: INTERACTUAR</p>
            </div>
        </div>
    </div>

    <!-- Ret√≠cula de mira -->
    <div id="crosshair">+</div>

    <!-- Overlay de Interacci√≥n (Mensaje flotante) -->
    <!-- Letter Overlay -->
    <div id="letter-overlay" class="hidden">
        <div class="letter-content">
            <h2 id="letter-title">Informe de Estado</h2>
            <span id="letter-date" class="date">22/01/26</span>
            <div id="letter-body">
                <p>El comando "party time" no funciona, debido al estado actual de los animatronicos, no se recomienda
                    activar el comando, el comportamiento de Foxy y Mangle es algo inestable.</p>
                <p style="text-align: right; margin-top: 20px;">- Equipo Mandarina</p>
            </div>
            <button id="close-letter">Cerrar</button>
        </div>
    </div>

    <!-- UI Interaction Message -->
    <div id="interaction-message">Click para ver</div>

    <!-- DIALOGO GORRION -->
    <div id="sparrow-dialog" class="hidden">
        <div class="dialog-content">
            <span id="dialog-text">...</span>
        </div>
    </div>

    <!-- Panel de Estad√≠sticas (TAB) -->
    <div id="stats-panel" class="hidden">
        <h3>SISTEMA DE MONITOREO</h3>
        <p>Distancia al Centro: <span id="dist-center">0.00</span> m</p>
    </div>

    <!-- Modal para ver el cuadro -->
    <div id="painting-modal" class="hidden">
        <div class="modal-content">
            <span id="close-modal">&times;</span>
            <img id="modal-image" src="" alt="Cuadro">
            <div id="modal-description">
                <h2 id="modal-title">T√≠tulo del Cuadro</h2>
                <p id="modal-text">Descripci√≥n...</p>
            </div>
        </div>
    </div>

    <!-- Modal para Mapa Mundi (Globo) -->
    <div id="map-modal" class="hidden">
        <div class="modal-content large-modal">
            <span id="close-map">&times;</span>
            <img id="map-image" src="textures/world_map.jpg" alt="Mapa Mundi Antiguo"
                onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_with_blue_sea.svg';">
            <div id="modal-description">
                <h2>Orbis Terrarum</h2>
                <p>Una vista cl√°sica del mundo conocido.</p>
            </div>
        </div>
    </div>

    <!-- Jumpscare Overlay -->
    <div id="jumpscare-overlay" class="hidden">
        <video id="jumpscare-video" preload="auto"
            style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;">
            <source src="videos/jumpscare.mp4" type="video/mp4">
        </video>
        <video id="jumpscare-video2" preload="auto"
            style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none;">
            <source src="videos/jumpscare2.mp4" type="video/mp4">
        </video>
    </div>

    <!-- Cinema Video Element (for L2 screen) -->
    <video id="cinema-video" style="display: none;" loop>
        <source src="" type="video/mp4">
    </video>

    <!-- Phone Modal -->
    <div id="phone-modal" class="hidden">
        <div class="phone-container">
            <div class="phone-screen">
                <span id="phone-display"></span>
            </div>
            <div class="phone-keypad">
                <button class="phone-btn" data-key="1">1</button>
                <button class="phone-btn" data-key="2">2</button>
                <button class="phone-btn" data-key="3">3</button>
                <button class="phone-btn" data-key="4">4</button>
                <button class="phone-btn" data-key="5">5</button>
                <button class="phone-btn" data-key="6">6</button>
                <button class="phone-btn" data-key="7">7</button>
                <button class="phone-btn" data-key="8">8</button>
                <button class="phone-btn" data-key="9">9</button>
                <button class="phone-btn" data-key="*">*</button>
                <button class="phone-btn" data-key="0">0</button>
                <button class="phone-btn" data-key="#">#</button>
            </div>
            <div class="phone-controls">
                <button id="phone-call" class="action-btn call">LLAMAR</button>
                <button id="phone-clear" class="action-btn clear">BORRAR</button>
            </div>
            <button id="phone-close">X</button>
        </div>
    </div>

    <!-- Interfaz computadora Retro -->
    <div id="pc-interface" class="hidden">
        <div class="pc-screen">
            <div class="pc-header">
                <span>MANDARINAOS v1.0</span>
                <span id="close-pc">X</span>
            </div>
            <div class="pc-desktop">
                <div class="pc-icon" id="icon-snake">
                    <div class="icon-img">üêç</div>
                    <div class="icon-label">SNAKE.EXE</div>
                </div>
                <!-- Nuevo Icono CMD -->
                <div class="pc-icon" id="icon-cmd">
                    <div class="icon-img">_></div>
                    <div class="icon-label">CMD.EXE</div>
                </div>
                <div class="pc-icon" id="icon-setup">
                    <div class="icon-img">‚öôÔ∏è</div>
                    <div class="icon-label">SETUP.EXE</div>
                </div>
                <div class="pc-icon" id="icon-internet">
                    <div class="icon-img">üåê</div>
                    <div class="icon-label">INTERNET</div>
                </div>
                <div class="pc-icon" id="icon-pony">
                    <div class="icon-img">ü¶Ñ</div>
                    <div class="icon-label">PONY.EXE</div>
                </div>
                <div class="pc-icon" id="icon-calc">
                    <div class="icon-img">üßÆ</div>
                    <div class="icon-label">CALC.EXE</div>
                </div>
            </div>

            <!-- Ventana Terminal -->
            <div id="pc-terminal" class="hidden">
                <div id="terminal-output">
                    <p>MANDARINAOS v1.0</p>
                    <p>(c) 2026 Mandarina Corp. All rights reserved.</p>
                    <br>
                </div>
                <div class="terminal-input-line">
                    <span>C:\USER></span>
                    <input type="text" id="cmd-input" maxlength="40" autocomplete="off" spellcheck="false" autofocus>
                </div>
            </div>

            <!-- Ventana Internet Browser -->
            <div id="pc-browser" class="hidden">
                <div class="browser-nav">
                    <span>URL:</span>
                    <input type="text" id="browser-input" placeholder="Search or type URL" autocomplete="off">
                    <button id="browser-go">GO</button>
                    <button id="browser-close">X</button>
                </div>
                <div class="browser-content">
                    <div class="browser-placeholder">
                        <h1>Mandarina Web</h1>
                        <p>Gateway to the World Wide Web</p>
                        <p class="blink">_</p>
                    </div>
                </div>
            </div>

            <!-- Ventana Pony Player -->
            <div id="pc-pony" class="hidden">
                <div class="pony-header">
                    <span>MY LITTLE PONY PLAYER</span>
                    <button id="pony-close">X</button>
                </div>
                <div class="pony-screen">
                    <div id="pony-placeholder">
                        <p>Loading Magic...</p>
                    </div>
                    <div id="pony-offline-msg" class="hidden"
                        style="position: absolute; top:0; left:0; width:100%; height:100%; background:black; color:red; display:flex; flex-direction:column; justify-content:center; align-items:center; font-family: monospace; z-index: 10;">
                        <h2 style="font-size: 2em; margin-bottom: 20px;">‚ö† ERROR 404 ‚ö†</h2>
                        <p>NETWORK CONNECTION MISSING</p>
                        <p>MAGIC CANNOT BE LOADED</p>
                    </div>
                    <iframe id="pony-iframe" width="100%" height="100%" src="" frameborder="0"
                        allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
                <div class="pony-controls">
                    <button id="pony-random">‚ú® EPISODIO RANDOM ‚ú®</button>
                </div>
            </div>

            <!-- Ventana Snake Game -->
            <div id="pc-snake" class="hidden">
                <div class="snake-header">
                    <span>SNAKE.EXE</span>
                    <button id="snake-close">X</button>
                </div>
                <div class="snake-game-area">
                    <canvas id="snake-canvas" width="560" height="280"></canvas>
                    <div id="snake-overlay" class="hidden">
                        <h2 id="snake-msg">GAME OVER</h2>
                        <p>Press SPACE to Restart</p>
                    </div>
                </div>
                <div class="snake-info">
                    <div class="score-board">SCORE: <span id="snake-score">0</span></div>
                    <div class="controls-hint">USE ARROW KEYS TO MOVE</div>
                </div>
            </div>

            <!-- Ventana SETUP / CONFIG -->
            <div id="pc-settings" class="hidden">
                <div class="settings-header">
                    <span>CONFIGURACI√ìN DEL SISTEMA</span>
                    <button id="settings-close">X</button>
                </div>

                <!-- TABS HEADER -->
                <div class="settings-tabs">
                    <button class="tab-btn active" data-tab="tab-general">GENERAL</button>
                    <button class="tab-btn" data-tab="tab-lights">ILUMINACI√ìN</button>
                </div>

                <div class="settings-body">
                    <!-- TAB GENERAL -->
                    <div id="tab-general" class="tab-content active">
                        <div class="group-box">
                            <div class="group-label">Hora del Sistema</div>
                            <div class="setting-row">
                                <span id="time-display">08:00</span>
                            </div>
                            <div class="setting-row">
                                <input type="range" id="time-slider" min="0" max="23.9" step="0.1" value="8">
                            </div>
                        </div>
                        <p class="hint">Ajusta el ciclo d√≠a/noche.</p>
                    </div>

                    <!-- TAB LIGHTS (SCHEMATIC) -->
                    <div id="tab-lights" class="tab-content">
                        <div class="group-box">
                            <div class="group-label">Esquema de Planta</div>
                            <div id="museum-schematic-grid">
                                <!-- Top Row -->
                                <div class="schematic-row">
                                    <button class="room-toggle active" data-room="L3">L3</button>
                                    <div class="room-spacer"></div>
                                    <button class="room-toggle active" data-room="R3">R3</button>
                                </div>
                                <!-- Middle Row -->
                                <div class="schematic-row">
                                    <button class="room-toggle active" data-room="L2">L2</button>
                                    <div class="room-spacer"></div>
                                    <button class="room-toggle active" data-room="R2">R2</button>
                                </div>
                                <!-- Bottom Row -->
                                <div class="schematic-row">
                                    <button class="room-toggle active" data-room="L1">L1</button>
                                    <button class="room-toggle active" data-room="CENTRAL">CEN</button>
                                    <button class="room-toggle active" data-room="R1">R1</button>
                                </div>
                            </div>
                        </div>

                        <div class="group-box">
                            <div class="group-label">Mecanismos Globales</div>
                            <div class="setting-row" style="flex-direction: column; gap: 5px;">
                                <button id="btn-ceiling-toggle" class="tab-btn"
                                    style="width: 100%; text-align: center;">ABRIR TECHO CORREDIZO</button>
                                <button id="btn-lights-off" class="tab-btn"
                                    style="width: 100%; text-align: center; background: #5a3333; color: white;">APAGAR
                                    TODO</button>
                            </div>
                        </div>

                        <p class="hint">Click para alternar energ√≠a.</p>
                    </div>
                </div>
            </div>

            <!-- Ventana Calculadora -->
            <div id="pc-calc" class="hidden">
                <div class="calc-header">
                    <span>CALCULADORA v1.0</span>
                    <button id="calc-close">X</button>
                </div>
                <div class="calc-body">
                    <div id="calc-display">0</div>
                    <div class="calc-buttons">
                        <button class="calc-btn" data-val="C">C</button>
                        <button class="calc-btn" data-val="/">/</button>
                        <button class="calc-btn" data-val="*">*</button>
                        <button class="calc-btn" data-val="DEL">DEL</button>

                        <button class="calc-btn" data-val="7">7</button>
                        <button class="calc-btn" data-val="8">8</button>
                        <button class="calc-btn" data-val="9">9</button>
                        <button class="calc-btn" data-val="-">-</button>

                        <button class="calc-btn" data-val="4">4</button>
                        <button class="calc-btn" data-val="5">5</button>
                        <button class="calc-btn" data-val="6">6</button>
                        <button class="calc-btn" data-val="+">+</button>

                        <button class="calc-btn" data-val="1">1</button>
                        <button class="calc-btn" data-val="2">2</button>
                        <button class="calc-btn" data-val="3">3</button>
                        <button class="calc-btn" data-val="=" id="calc-equal">=</button>

                        <button class="calc-btn wide" data-val="0">0</button>
                        <button class="calc-btn" data-val=".">.</button>
                    </div>
                </div>
            </div>

            <div class="pc-footer">
                READY.
            </div>
        </div>
    </div>

    <!-- Pong Overlay -->
    <div id="pong-overlay" class="hidden">
        <canvas id="pong-canvas" width="800" height="600"></canvas>
        <div id="pong-instruction">CONTROLS: ARROW KEYS | ESC TO EXIT</div>
    </div>

    <style>
        #pong-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        #pong-overlay.hidden {
            display: none;
        }

        #pong-canvas {
            border: 4px solid #FFD700;
            box-shadow: 0 0 20px #FFD700;
            background: black;
            image-rendering: pixelated;
        }

        #pong-instruction {
            margin-top: 20px;
            color: #FFD700;
            font-family: 'Courier New', monospace;
            font-size: 20px;
            text-shadow: 0 0 5px #FFD700;
        }
    </style>

    <!-- Inventory GUI -->
    <div id="inventory-gui">
        <div class="inventory-slot hidden" id="slot-key" title="Llave Dorada">
            <div class="key-icon hidden">üîë</div>
        </div>
        <!-- Flashlight Slot: Hidden by default -->
        <div class="inventory-slot hidden" id="slot-flashlight" title="Linterna (Q)">
            <div class="flashlight-icon hidden">üî¶</div>
            <div class="battery-indicator hidden" id="battery-indicator">
                <div class="battery-bar"></div>
                <div class="battery-bar"></div>
                <div class="battery-bar"></div>
            </div>
        </div>
    </div>

    <style>
        .battery-indicator {
            position: absolute;
            left: 50%;
            bottom: -12px;
            /* Move below the slot */
            transform: translateX(-50%);
            display: flex;
            /* Flex row by default? No, vertical bars or horizontal? */
            /* User said "3 barras". Vertical stack or horizontal? */
            /* Reference images usually horizontal or vertical. */
            /* My previous CSS was flex-direction: column (Vertical stack). */
            /* If it's below, meaningful to be horizontal? */
            /* "Debajo del mismo slot". */
            /* Let's keep vertical stack but make it small, or horizontal bar? */
            /* Let's switch to Horizontal Row below the slot. */
            flex-direction: row;
            gap: 2px;
            width: 100%;
            justify-content: center;
        }

        .battery-bar {
            width: 10px;
            height: 6px;
            background-color: #00ff00;
            border: 1px solid #000;
        }

        .battery-bar.off {
            background-color: #333;
        }

        .flashlight-icon {
            font-size: 24px;
        }

        /* Helper to hide slot itself */
        #slot-flashlight.hidden {
            display: none;
        }
    </style>

    <script type="module" src="./src/main.js"></script>
    <!-- PDF Overlay -->
    <div id="pdf-overlay" class="hidden">
        <div class="pdf-container">
            <button id="pdf-close">X</button>
            <iframe id="pdf-frame" src=""></iframe>
        </div>
    </div>

    <style>
        #pdf-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 4000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #pdf-overlay.hidden {
            display: none;
        }

        .pdf-container {
            width: 80%;
            height: 90%;
            background: #fff;
            position: relative;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        #pdf-frame {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 5px;
        }

        #pdf-close {
            position: absolute;
            top: -15px;
            right: -15px;
            background: red;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
        }

        #pdf-close:hover {
            background: darkred;
        }
    </style>
</body>

</html>